## О проекте

2020 год ознаменовался очередной девальвацией российского рубля. Начиная с февраля 2020 г., рубль упал более чем на 20-30% по отношению доллару и евро. Но, несмотря на это, официальная статистика уверяет, что инфляция в стране не превышает "целевых 4%", что "пенсии увеличиваются в полтора раза быстрее, чем ценники в магазинах".

Для того чтобы получить собственную оценку потребительской инфляции, был разработан настоящий проект. Приложение осуществляет запросы к веб-каталогу типового продуктового супермаркета, и считывает из html-страницы перечень товаров и цен, который сохраняется в БД.

## Описание проекта

### Структура БД

Схема БД состоит из двух таблиц:
    
                         +--------------+
    +----------+         | prices       |
    | prods    |         +--------------+
    +----------+         | date         | -PK
    | id (PK)  +-------->+ prod_id (FK) | -PK
    | partnum  |         | price        |
    | name     |         +--------------+
    | cat      |
    +----------+
    
Таблица `prods` содержит полный список всех товаров, по которым ведется учет. Поле `id` - целочисленный идентификатор товара (первичный ключ), генерируемый СУБД (тип `serial`). Поля `partnum` и `name` - артикул и наименование товара в соответствии с каталогом (уникальная пара). Поле `cat` - условный номер категории товара.

Таблица `prices` содержит выборку цен товаров на конкретное число: `date` - дата выборки, `prod_id` - идентификатор товара (внешний ключ к таблице `prods`), `price` - цена. Используется составной первичным ключ по столбцам (`date`, `prod_id`).

Кроме того, имеется функция `sel_ins(partnum integer, name text, cat integer)`, которая либо возвращает id существующего товара, либо осуществляет вставку с возвращением id.

### Основные классы

Класс `OnlineCatalog` предназначен для извлечения информации о товарах из онлайн-каталога, и реализован на основе библиотеки парсинга html-страниц *Jsoup*. В классе содержится два статических метода:

* `int numOfPages(String cat)` - возвращает количество страниц каталога для заданной категории. Имя категории представляет собой часть пути URL, по которому расположен данный раздел. Массив имен задается в методе main() класса Main. Каждому наименованию сопоставлен условный порядковый номер, который сохраняется в таблицу БД в поле `cat`.

* `Map<Product, Double> getPages(String cat, int m, int n)` - возвращает перечень товаров и цен для заданной категории, где `n` - количество запрашиваемых страниц (1..20), `m` - с какой страницы начинать. Все страницы запрашиваются одновременно (в многопоточном режиме).

Класс `GetPageTask` инкапсулирует задачу получения одной страницы, реализуя интерфейс `Callable<Map<Product, Double>>`. Имеет доступ по умолчанию внутри пакета `catalog`.

Пакет `dao` содержит класс и интерфейс dao-объекта, содержащего единственный метод сохранения отображания `Map<>` в таблицы БД. Реализован как синглтон (со статическим методом генерации) на основе `JdbcTemplate` и `TransactionTemplate` (один вызов метода `save()` соответствует одной транзакции к БД).

Пакет `entity` содержит сущностный класс `Product`, представляющий наименование товара и его артикул, получаемые из каталога.

В методе main() задается массив имен категорий товаров в соответствии с URL раздела онлайн-каталога. Для каждой категории (в цикле) осуществляется запрос страниц каталога (сначала - по 20, затем - остаток), исключение дублирующих элементов (которые уже ранее были отправлены в БД), и отправка результатов в БД через dao-объект.

### Содержимое каталога sql-скриптов *src/sql*

* `schema.sql` - создание схемы БД;
* `drop.sql` - удаление схемы БД;
* `total_received.sql` - количество принятых товаров по датам;
* `view_double_products.sql` - просмотр товаров с одинаковыми наименованиями (но разными артикулами).
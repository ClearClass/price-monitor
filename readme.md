## О проекте

2020 год ознаменовался очередной девальвацией российского рубля. Начиная с февраля 2020 г., рубль упал более чем на 20-30% по отношению к доллару и евро. Одновременно с этим произошло резкое повышение цен на многие виды продуктов питания и большинство других потребительских товаров. Однако официальная статистика, имеющая ряд особенностей при расчете показателей уровня инфляции, не всегда отражает реальный прирост цен на прилавках магазинов. 

Для того чтобы получить собственную оценку потребительской инфляции, был разработан настоящий проект. Приложение осуществляет запросы к веб-каталогу типового продуктового супермаркета, и получает (из html-страницы) перечень товаров и цен, которые сохраняются в базу данных. Далее, с использованием прилагаемых sql-скриптов, рассчитываются усредненные показатели динамики цен.

## Описание проекта

### Схема БД

Схема БД состоит из трех таблиц:

                                          +--------------+
                     +----------+         | prices       |
                     | prods    |         +--------------+
                     +----------+         | date         | +PK
    +--------+       | id (PK)  +-------->+ prod_id (FK) | +PK
    | cats   |       | partnum  |         | price        |
    +--------+       | name     |         +--------------+
    | cat(PK)+------>+ cat      |
    | name   |       +----------+
    +--------+
    
Таблица `cats` содержит список категорий товаров и включает в себя два столбца: `name` - наименование категории, и `cat`- условный порядковый номер категории (первичный ключ таблицы `cats`). Заполнение таблицы `cats` производится при создании схемы БД.
    
Таблица `prods` содержит полный список всех товаров, по которым ведется учет. Поле `id` - целочисленный идентификатор товара (первичный ключ), генерируемый СУБД (тип `serial`). Поля `partnum` и `name` - артикул и наименование товара согласно каталогу (уникальная пара). Поле `cat` - номер категории товара, являющийся внешним ключем по отношению к таблице `cats`.

Таблица `prices` содержит выборку цен товаров на конкретное число: `date` - дата выборки, `prod_id` - идентификатор товара (внешний ключ к таблице `prods`), `price` - цена. Используется составной первичный ключ по столбцам (`date`, `prod_id`).

Кроме того, имеется функция `sel_ins(partnum integer, name text, cat integer)`, которая либо возвращает id существующего товара из таблицы `prods`, либо осуществляет вставку с возвращением id.

### Основные классы

Класс `OnlineCatalog` предназначен для извлечения информации о товарах из онлайн-каталога, и реализован на основе библиотеки парсинга html-страниц *Jsoup*. В классе содержится два статических метода:

* `int numOfPages(String cat)` - возвращает количество страниц каталога для заданной категории. Имя категории `cat` представляет собой часть пути URL, по которому расположен данный раздел. Список имен задается в методе `main()`.

* `Map<Product, Double> getPages(String cat, int m, int n)` - возвращает перечень товаров и цен для заданной категории `cat`, где `n` - количество запрашиваемых страниц (1..20), `m` - с какой страницы начинать. Все страницы запрашиваются одновременно (в многопоточном режиме).

Класс `GetPageTask` инкапсулирует задачу получения одной страницы, реализуя интерфейс `Callable<Map<Product, Double>>`. Имеет доступ по умолчанию внутри пакета `catalog`. Всего производится 5 попыток получения страницы; при неудачном исходе генерируется исключение.

Пакет `dao` содержит класс и интерфейс dao-объекта, содержащего единственный метод сохранения отображания `Map<Product, Double>` в таблицы БД. Реализован как синглтон (со статическим методом генерации) на основе `JdbcTemplate` и `TransactionTemplate` (один вызов метода `save()` соответствует одной транзакции к БД).

Пакет `entity` содержит сущностный класс `Product`, представляющий наименование товара и его артикул, получаемые из каталога.

В методе `main()` задается множество имен категорий товаров в соответствии с URL раздела онлайн-каталога. Для каждой категории (в цикле) осуществляется запрос страниц каталога (сначала - по 20, затем - остаток), удаление дублирующих элементов (которые уже ранее были добавлены в БД), и отправка результатов в БД через dao-объект.

### Содержимое каталога sql-скриптов *src/sql*

* `init.sql` - создание схемы БД и sql-функций, используемых в запросах;

* `drop.sql` - удаление схемы БД;

* `total_received_on_dates.sql` - количество принятых товаров (ценовых данных) по датам;

* `received_in_cats_on_last_date.sql` - количество принятых товаров по категориям на последнюю дату;

* `prods_with_same_name.sql` - список товаров, имеющих одинаковое название, но различный артикул. Такие товары всегда считаются разными, поскольку, с одной стороны, могут присутствовать даже в пределах одной выборки, а с другой стороны, невозможно достоверно определить, изменился ли лишь артикул, или же поменялся сам товар. Данное допущение повышает достоверность расчетов, поскольку, несмотря на некоторое уменьшение объема выборки, из расчета исключаются потенциально ошибочные строки.

* `prods_with_same_partnum.sql` - список товаров, имеющих одинаковые артикулы, но различные наименования. Как правило, такие позиции получаются в результате переименования товаров к моменту следующей выборки, т.е. по сути представляют собой один и тот же товар. Это, в принципе, позволяет использовать в качестве уникального идентификатора товара его `partnum`. Однако и здесь не исключена ситуация, когда новый товар получает прежний артикул. Поэтому в дальнейшем в качестве идентификатора товара используется все же его `id`. Связывание по `partnum` также возможно, однако для этого необходимо иметь некую агрегатную функцию, которая будет анализировать группу (`name`) на предмет возможного переименования товара.

* `price_changes_on_last_date.sql` - приращения цен по всему списку товаров за один месяц на последнюю дату. Строки, для которых изменение цены составило более 900% или менее -95%, считаются ошибочными и в результаты запроса не включаются.

* `init.sql`, `avg_per()` - функция для расчета среднего прироста цен за один месяц на заданную дату (по всем категориям товаров). В качестве выходного аргумента также возвращается количество строк (товаров), по которым проводилось усреднение.

* `prices_change_on_all_dates.sql` - запрос, который использует предыдущую функцию для расчета среднего прироста цен (за месяц) по всем датам измерений.

* `init.sql`, `avg_per_in_cat()` - функция для расчета среднего прироста цен за один месяц на заданную дату в заданной категории. В качестве выходного аргумента также возвращается количество строк (товаров), по которым проводилось усреднение.

* `price_changes_in_cats_on_last_date.sql` - запрос, который использует предыдущую функцию для расчета среднего прироста цен (за месяц) по каждой категории в отдельности (на последнюю дату).

* `prices_change_on_full_time.sql` - средний прирост цен за все время измерений (по всем категориям товаров).

### История версий

* Версия 1.0 - базовая версия.
* Версия 1.1 - добавлены расчетные sql-скрипты; в классе `GetPageTask` введено 5 попыток для получения страницы.
* Версия 1.11 - откорректированы (приведены к более общему виду) запросы `price_changes_on_last_date.sql`, `price_changes_in_cats_on_last_date.sql`.
* Версия 1.2 - http-клиент Jsoup заменен на `HttpURLConnection`; добавлен скрипт `received_in_cats_on_last_date.sql`; обновлен url онлайн-каталога; добавлена категория 11, объединенная с 7.
